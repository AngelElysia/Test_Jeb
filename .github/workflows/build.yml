name: Simple Cross-Platform Build (确保构建成功)
on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch: # 支持手动触发，方便测试

# 定义全局环境变量（整个 workflow 可引用）
env:
  APP_NAME: "jetbra-free" # 统一程序名称，避免重复编写

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      # 只保留核心平台，减少构建失败概率
      matrix:
        target:
          - os: linux
            arch: amd64
            ext: ""
          - os: windows
            arch: amd64
            ext: ".exe"
          - os: darwin
            arch: amd64
            ext: ""
    name: Build ${{ matrix.target.os }}-${{ matrix.target.arch }}

    steps:
      # 步骤1：拉取代码（使用最新稳定版）
      - name: Checkout code
        uses: actions/checkout@v4

      # 步骤2：安装 Go 环境（锁定版本，避免波动）
      - name: Set up Go 1.22
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"
          cache: true # 缓存依赖，加速构建

      # 步骤3：安装 go-bindata（锁定版本，避免兼容问题）
      - name: Install go-bindata
        run: |
          go install http://github.com/go-bindata/go-bindata/v3/go-bindata@latest
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

      # 步骤4：生成 bindata 文件（资源嵌入，核心步骤）
      - name: Generate bindata
        run: |
          # 确保输出目录存在，避免报错
          mkdir -p internal/util
          go-bindata -o internal/util/access.go -pkg util static/... templates/... cache/...

      # 步骤5：编译二进制文件（适配 UOS 10，核心优化）
      - name: Build binary
        run: |
          OUTPUT_DIR="dist"
          mkdir -p $OUTPUT_DIR

          # 编译参数：禁用 CGO+静态编译+减小体积，确保 UOS 10 兼容
          CGO_ENABLED=0 \
          GOOS=${{ matrix.target.os }} \
          GOARCH=${{ matrix.target.arch }} \
          GOFLAGS="-buildmode=pie" \
          go build \
            -mod=vendor \ # 优先使用本地 vendor 依赖，避免网络问题
            -trimpath \ # 移除编译路径，减小体积
            -ldflags "-w -s" \ # 移除调试信息，进一步减小体积
            -o $OUTPUT_DIR/${{ env.APP_NAME }}-${{ matrix.target.os }}-${{ matrix.target.arch }}${{ matrix.target.ext }} \
            cmd/main.go

      # 步骤6：上传构建产物（修复变量引用，确保识别）
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          # 引用全局环境变量：${{ env.APP_NAME }}
          name: ${{ env.APP_NAME }}-${{ matrix.target.os }}-${{ matrix.target.arch }}
          path: |
            dist/${{ env.APP_NAME }}-${{ matrix.target.os }}-${{ matrix.target.arch }}${{ matrix.target.ext }}
          retention-days: 7 # 产物保留7天，节省空间
